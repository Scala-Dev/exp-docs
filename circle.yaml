machine:
  environment:
    GCLOUD: /opt/google-cloud-sdk/bin/gcloud
    BASE: us.gcr.io/exp-core-develop/docs
    APP: docs
  services:
    - docker

dependencies:
  post:
    - jekyll build

test:
  override:
    - echo 0

deployment:

  release:
    branch: /release\/.*/
    commands:
      - sudo $GCLOUD --quiet components update --version 144.0.0
      - sudo $GCLOUD --quiet components update --version 144.0.0 kubectl
      - echo $GCLOUD_KEY | base64 --decode -i > $HOME/gcloud-service-key.json
      - sudo $GCLOUD auth activate-service-account --key-file $HOME/gcloud-service-key.json
      - sudo docker build -t $BASE:${CIRCLE_BRANCH:8}-$CIRCLE_BUILD_NUM .
      - sudo $GCLOUD docker -- push $BASE:${CIRCLE_BRANCH:8}-$CIRCLE_BUILD_NUM
      - sudo $GCLOUD config set container/use_client_certificate True
      - sudo $GCLOUD config set project exp-core-develop
      - sudo $GCLOUD config set compute/zone us-east1-d
      - sudo $GCLOUD config set container/cluster ${CIRCLE_BRANCH:8}
      - sudo $GCLOUD container clusters get-credentials ${CIRCLE_BRANCH:8}
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - kubectl set image deployment/$APP $APP=$BASE:${CIRCLE_BRANCH:8}-$CIRCLE_BUILD_NUM
      - kubectl rollout status deployment/$APP
